# CustomThreadPoolExecutor

---
## Описание проекта

Данный проект реализует кастомизированную версию пула потоков с настраиваемым управлением очередями, логированием, параметрами и политикой отказа для обеспечения гибкости и эффективности реализации многопоточной среды в высоконагруженных приложениях. <br>
Реализация пула и демонстрационная программа (`Main`) представлены в пакете ``custom_ThreadPool``.

Также в пакете ``performance_research`` реализованы [тесты](#тесты-исследование) для анализа производительности по сравнению со встроенными в Java реализации пулов потоков (`PerformanceTest`) и оптимальных параметров конфигурации кастомного пула потоков (`ParameterTuningTest`).

---
## Алгоритм распределения задач

Распределение задач между потоками реализовано по принципу наименьшей загруженности (Least Loaded).

**Принцип работы**:
1. У каждого потока есть своя очередь задач (BlockingQueue). <br>
2. При добавлении новой задачи метод `getLeastLoadedQueue()` находит очередь с наименьшим количеством задач. <br>
3. Если в найденной очереди есть место, задача добавляется в нее. <br>
4. Если в пуле недостаточно активных потоков, создается новый поток (при условии, что не превышен maxPoolSize). <br>
5. Если все очереди заполнены, срабатывает механизм отказа.

**Преимущества**:
- Равномерное распределение нагрузки между потоками.
- Уменьшение задержек из-за длинных очередей.

**Недостатки**:
- Вариант с `stream().min()` требует перебора всех очередей, что может стать узким местом при очень высоких нагрузках.

---
## Механизм отказа
Если все очереди заполнены и пул не может создать новый поток, применяется следующий механизм отказа:

1. В лог выводится сообщение:
`[Rejected] Task <...> was rejected due to overload!`

2. Если число активных потоков меньше ``maxPoolSize``, задача выполняется в текущем потоке.

3. В противном случае:
   - Поток ожидает 5 мс.
   - Повторно пытается добавить задачу в наименее загруженную очередь.
   - Если повторная попытка не удалась, поток опять ожидает 5 мс.
   - Затем повторно пытается добавить задачу в наименее загруженную очередь.

   И так пока задача не добавится в очередь

**Преимущества**:
- При перегрузке задачи по возможности обрабатываются немедленно, что предотвращает простаивание вычислительных мощностей.
- Повторная попытка добавления задачи в очередь может помочь, если временная перегрузка была вызвана пиковыми нагрузками.

**Недостатки**:
- Выполнение задачи в текущем потоке может привести к блокировке вызывающего потока, если задача тяжелая.
- Ожидание перед повторной попыткой может немного увеличить задержку в обработке новых задач.


# Тесты (Исследование производительности)

---
## Описание тестов

### 1. **PerformanceTest** (Анализ производительности)
#### Назначение:
Сравнение скорости выполнения задач в **CustomThreadPoolExecutor** и стандартных **ThreadPoolExecutor** из Java.

#### Алгоритм работы теста:
1. Запускает выполнение заданного числа задач в разных реализациях пулов потоков:
   - **CustomThreadPoolExecutor**
   - **FixedThreadPool**
   - **CachedThreadPool**
   - **SingleThreadExecutor**
2. Измеряет общее время выполнения задач для каждого пула.
3. После завершения всех потоков выводит таблицу с результатами.

#### Результаты:
**Условия**:<br>
- Всего 1000 задач
- Выполнение каждой задачи 10 мс (``thread.sleep(10);``)
- для CustomThreadPool заданы следующие параметры:
  - corePoolSize = 4
  - maxPoolSize = 8 и 16
  - keepAliveTime = 5 (seconds)
  - queueSize = 100
  - minSpareThreads = 2
- для FixedThreadPool задано количество потоков = 8

**Результаты**:

| Executor Type                     | Total Time (ms) | Avg Task Time (ms) | Tasks Completed |
|-----------------------------------|-----------------|--------------------|-----------|
| CustomThreadPool (maxPoolSize=8)  | 270             | 0,27               | 1000      |
| CustomThreadPool (maxPoolSize=16) | 56              | 0,06               | 1000      |
| FixedThreadPool  (8)              | 2018            | 2,02               | 1000      |
| FixedThreadPool  (16)             | 1010            | 1,01               | 1000      |
| CachedThreadPool                  | 58              | 0,06               | 1000      |      
| SingleThreadExecutor              | 16849           | 16,85              | 1000      |

- **Executor Type** – тип пула
- **Total Time (ms)** – общее время выполнения задач в миллисекундах
- **Avg Task Time (ms)** – среднее время выполнения одной задачи

#### Выводы
- ``CustomThreadPool`` превосходит по производительности ``FixedThreadPool`` как с 8 так и с 16 потоками.

- ``CustomThreadPool`` с 16 потоками и ``CachedThreadPool`` показывают примерно одинаковые результаты производительности. (в таблицы приведен один из результатов. Результаты тестов всегда менялись в зависимости от загрузки системы, но данные пулы всегда показывали примерно одинаковый результат).

- ``SingleThreadExecutor`` как и ожидалось, показал худший результат. 

---

### 2. **ParameterTuningTest** (Оптимизация параметров пула)
#### Назначение:
Определение степени влияния различных параметров на производительность CustomThreadPool и подбор наиболее эффективных комбинаций параметров для CustomThreadPoolExecutor.

#### Алгоритм работы теста:
1. Запускает тесты с разными параметрами пула (**corePoolSize, maxPoolSize, queueSize, keepAliveTime, minSpareThreads**).
2. Выполняет серию задач и общее и среднее время выполнения задач.
3. После завершения всех потоков выводит таблицу с результатами.

#### Результаты:
**Условия:**
- Всего 1000 задач
- Выполнение каждой задачи 10 мс (``thread.sleep(10);``)

| CoreSize | MaxSize | Queue | KeepAlive | MinSpare | Total Time (ms) | Avg Task Time (ms) | Threads Created |
|:--------:|:-------:|:-----:|:---------:|:--------:|:---------------:|:------------------:|:---------------:|
|    2     |    8    |  50   |     5     |    2     |       785       |        0,79        |        8        |
|    4     |    8    |  50   |     5     |    2     |       732       |        0,73        |        8        |
|    8     |    8    |  50   |     5     |    2     |       704       |        0,70        |        8        |
|    4     |    8    |  50   |     5     |    2     |       708       |        0,71        |        8        |
|    4     |   16    |  50   |     5     |    2     |       159       |        0,16        |       16        |
|    4     |   32    |  50   |     5     |    2     |       25        |        0,03        |       32        |
|    4     |    8    |  10   |     5     |    2     |      1057       |        1,06        |        8        |
|    4     |    8    |  50   |     5     |    2     |       691       |        0,69        |        8        |
|    4     |    8    |  100  |     5     |    2     |       241       |        0,24        |        8        |
|    4     |    8    |  50   |     5     |    2     |       671       |        0,67        |        8        |
|    4     |    8    |  50   |    10     |    2     |       696       |        0,70        |        8        |
|    4     |    8    |  50   |     5     |    2     |       682       |        0,68        |        8        |
|    4     |    8    |  50   |     5     |    1     |       682       |        0,68        |        8        |
|    4     |    8    |  50   |     5     |    4     |       684       |        0,68        |       8         |

- **CoreSize** – базовое количество потоков.
- **MaxSize** – максимальное количество потоков.
- **Queue** – размер очереди задач.
- **KeepAlive (s)** – время ожидания перед завершением потока.
- **MinSpare** – минимальное количество дополнительных потоков.
- **Total Time (ms)** – общее время выполнения задач.
- **Avg Task Time (ms)** – среднее время выполнения одной задачи
- **Created Threads** – количество созданных потоков в пуле.

#### Выводы

|Параметр	|    Влияние	    | Оптимальное значение |
|:--------:|:--------------:|:--------------------:|
|corePoolSize	|    Среднее     |          	4          |
|maxPoolSize	|    Сильное	    |        16-32         |
|queueSize	|    Сильное	    |         100          |
|keepAliveTime	| Незначительное |      	5 секунд       |
|minSpareThreads	| Незначительное |          	2          |

Наибольшее влияние на производительность оказывают maxPoolSize и queueSize. <br>
Наилучшие параметры для теста:<br>
`corePoolSize = 4, MaxPoolSize = 16-32, QueueSize = 100, KeepAlive = 5, MinSpare = 2`.

---

## Возможные улучшения

- Тестировать пул при различных типах нагрузки (IO-задачи, CPU-задачи).
- Реализовать поддержку динамического изменения параметров пула во время работы.

